[importlinter]
root_packages =
    apps
    core
    infra
include_external_packages = False

[contract:core_no_apps_infra]
name = Core must not import apps/infra
type = forbidden
source_modules = core
forbidden_modules =
    apps
    infra

[contract:infra_no_apps]
name = Infra must not import apps
type = forbidden
source_modules = infra
forbidden_modules =
    apps

[contract:apps_composition_roots_only]
name = Apps can only import infra in composition roots (DI containers)
type = forbidden
source_modules =
    apps.api.routers
    apps.api.services
    apps.api.middleware
    apps.bot.handlers
    apps.bot.services
    apps.bot.middlewares
    apps.bot.utils
    apps.bot.adapters
    apps.jobs.tasks
forbidden_modules =
    infra
unmatched_ignore_imports_alerting = warn
ignore_imports =
    # ============================================================================
    # COMPOSITION ROOT PATTERN: DI Containers are allowed to import infra
    # ============================================================================
    # DI containers wire concrete implementations (infra) to interfaces (ports)
    # This is the ONLY place in apps layer where infra imports are acceptable
    #
    # Composition Root Definition (Clean Architecture):
    # - Sits at outermost layer
    # - Knows about ALL layers (core, infra, apps)
    # - Wires concrete implementations to abstract interfaces
    # - Only place where infra dependencies are instantiated

    # Main DI Container imports sub-containers (composition)
    apps.di -> apps.di.database_container
    apps.di -> apps.di.cache_container
    apps.di -> apps.di.bot_container
    apps.di -> apps.di.mtproto_container
    apps.di -> apps.di.analytics_container
    apps.di -> apps.di.provider_modules

    # Database Container (14 repositories + connection manager)
    apps.di.database_container -> infra.db.connection_manager
    apps.di.database_container -> infra.db.repositories.admin_repository
    apps.di.database_container -> infra.db.repositories.analytics_repository
    apps.di.database_container -> infra.db.repositories.channel_daily_repository
    apps.di.database_container -> infra.db.repositories.channel_repository
    apps.di.database_container -> infra.db.repositories.edges_repository
    apps.di.database_container -> infra.db.repositories.payment_repository
    apps.di.database_container -> infra.db.repositories.plan_repository
    apps.di.database_container -> infra.db.repositories.post_metrics_repository
    apps.di.database_container -> infra.db.repositories.post_repository
    apps.di.database_container -> infra.db.repositories.schedule_repository
    apps.di.database_container -> infra.db.repositories.stats_raw_repository
    apps.di.database_container -> infra.db.repositories.user_bot_repository_factory
    apps.di.database_container -> infra.db.repositories.user_repository

    # Cache Container (1 factory)
    apps.di.cache_container -> infra.factories.repository_factory

    # MTProto Container (1 repository factory)
    apps.di.mtproto_container -> infra.db.repositories.user_bot_repository_factory

    # Bot Container imports provider modules
    apps.di.bot_container -> apps.di.provider_modules

    # Provider Modules imports sub-modules
    apps.di.provider_modules -> apps.di.provider_modules.adapters
    apps.di.provider_modules -> apps.di.provider_modules.bot_services
    apps.di.provider_modules -> apps.di.provider_modules.content_protection_providers
    apps.di.provider_modules -> apps.di.provider_modules.metrics_providers

    # Provider Modules - Adapters (implements TelegramBotPort)
    apps.di.provider_modules.adapters -> infra.adapters.analytics.aiogram_bot_adapter

    # Provider Modules - Bot Services (cache + payment gateway)
    apps.di.provider_modules.bot_services -> infra.cache.redis_cache_adapter
    apps.di.provider_modules.bot_services -> infra.services.payment

    # Provider Modules - Content Protection (payment gateway - imports on line 55)
    apps.di.provider_modules.content_protection_providers -> infra.services.payment

    # Provider Modules - Metrics (chart rendering with matplotlib)
    apps.di.provider_modules.metrics_providers -> infra.rendering.charts

    # Analytics Container (7 repositories + cache + telethon client)
    # âœ… REFACTORED (Nov 18, 2025): Moved from apps.api.di_analytics to apps.di.analytics_container
    apps.di.analytics_container -> infra.cache.redis_cache
    apps.di.analytics_container -> infra.db.repositories.channel_daily_repository
    apps.di.analytics_container -> infra.db.repositories.channel_repository
    apps.di.analytics_container -> infra.db.repositories.edges_repository
    apps.di.analytics_container -> infra.db.repositories.post_metrics_repository
    apps.di.analytics_container -> infra.db.repositories.post_repository
    apps.di.analytics_container -> infra.db.repositories.stats_raw_repository
    apps.di.analytics_container -> infra.tg.telethon_client

    # Security engine in core (special case - needs refactoring)
    apps.api.routers.* -> core.security_engine
    apps.api.auth_utils -> core.security_engine
    apps.api.auth_utils -> core.security_engine.container
    # Routers and services using DI containers (composition root injection)
    apps.api.routers.* -> apps.di
    apps.api.routers.* -> apps.di.analytics_container
    apps.api.routers.user_mtproto.* -> apps.di
    apps.api.services.* -> apps.di
    apps.bot.handlers.* -> apps.di

    # ============================================================================
    # Phase 5 approved: Deprecated files (delete Oct 21, 2025)
    # ============================================================================
    apps.api.deps -> infra
    apps.bot.deps -> infra
    apps.bot.middlewares.dependency_middleware -> infra

    # ============================================================================
    # Phase 5 approved: Utility functions
    # ============================================================================
    apps.bot.utils.init_db -> infra

    # ============================================================================
    # Known technical debt - Direct infra imports (pending refactor)
    # ============================================================================
    # API content_protection direct DB imports (Issue #4 - pending refactor)
    apps.api.routers.content_protection_router -> infra.db.connection_manager
    apps.api.routers.content_protection_router -> infra.db.repositories.user_repository

    # Exports via DI chain (Issue #4)
    apps.api.routers.exports_router -> apps.di
    apps.bot.handlers.exports -> apps.di

    # ============================================================================
    # Type annotations only (not runtime imports)
    # ============================================================================
    apps.api.routers.user_mtproto.deps -> infra.db.repositories.user_bot_repository
    apps.api.services.telegram_storage_service -> infra.db.models.telegram_storage

# Note: apps.di.* and apps.mtproto.* are intentionally allowed to import infra
# - apps.di.* are DI containers (composition roots)
# - apps.mtproto.* is an infrastructure adapter layer
# These are excluded from forbidden contracts by not being in source_modules
