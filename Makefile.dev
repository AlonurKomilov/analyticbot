# Development-specific Makefile targets
# Use this for venv-based development

.PHONY: dev-help dev-start dev-stop dev-status dev-logs dev-install dev-migrate dev-test dev-clean dev-cleanup dev-cleanup-cron-install dev-cleanup-cron-remove dev-kill-zombies dev-admin-install dev-admin-start dev-admin-stop dev-admin-build

dev-help:
	@echo "ðŸ”¥ Development Commands (venv-based)"
	@echo "===================================="
	@echo "  dev-install       - Install dependencies in venv"
	@echo "  dev-start         - Start development servers + CloudFlare Tunnel"
	@echo "  dev-stop          - Stop all development services + cleanup orphans"
	@echo "  dev-tunnel        - Start CloudFlare Tunnel only (public access)"
	@echo "  dev-tunnel-status - Show current tunnel URL and frontend config"
	@echo "  dev-status        - Check service status"
	@echo "  dev-logs          - Show development logs"
	@echo "  dev-migrate       - Run database migrations"
	@echo "  dev-test          - Run tests in venv"
	@echo "  dev-clean         - Clean development artifacts"
	@echo ""
	@echo "ðŸ” Admin Panel Commands"
	@echo "======================="
	@echo "  dev-admin-install  - Install admin frontend dependencies"
	@echo "  dev-admin-start    - Start admin frontend (port 11310)"
	@echo "  dev-admin-stop     - Stop admin frontend"
	@echo "  dev-admin-build    - Build admin frontend for production"
	@echo ""
	@echo "ðŸ§¹ Cleanup Commands"
	@echo "==================="
	@echo "  dev-cleanup             - Run orphaned process cleanup now"
	@echo "  dev-cleanup-cron-install - Install auto-cleanup cron (every 5 min)"
	@echo "  dev-cleanup-cron-remove  - Remove auto-cleanup cron job"
	@echo "  dev-kill-zombies        - Force kill zombie parent processes"
	@echo ""
	@echo "ðŸ³ Production Commands (Docker-based)"
	@echo "====================================="
	@echo "  up             - Start production services"
	@echo "  down           - Stop production services"
	@echo "  logs           - Show production logs"
	@echo "  migrate        - Run migrations in Docker"

dev-install:
	@echo "ðŸ“¦ Installing development dependencies..."
	python -m venv venv --upgrade-deps
	venv/bin/pip install -r requirements.txt
	cd apps/frontend && npm install

dev-start:
	@echo "ðŸš€ Starting development environment..."
	./scripts/dev-start.sh all

dev-stop:
	@echo "ðŸ›‘ Stopping development environment..."
	./scripts/dev-start.sh stop
	@echo "ðŸ§¹ Running orphaned process cleanup..."
	./scripts/cleanup_orphaned_processes.sh || true
	@echo "âœ… All development services stopped and cleaned up"

dev-tunnel:
	@echo "ðŸŒ Starting CloudFlare Tunnel for public access..."
	./scripts/dev-start.sh tunnel

dev-tunnel-status:
	@echo "ðŸŒ CloudFlare Tunnel Status"
	@echo "==========================="
	@if [ -f ".tunnel-current" ]; then \
		cat .tunnel-current; \
		echo ""; \
		echo "Frontend .env.local:"; \
		grep "^VITE_API_BASE_URL=" apps/frontend/.env.local || echo "  (not set)"; \
		echo ""; \
		echo "Recent tunnel updates:"; \
		tail -n 5 logs/tunnel-update.log 2>/dev/null || echo "  (no updates logged yet)"; \
		echo ""; \
		echo "Tunnel process:"; \
		ps aux | grep -E "cloudflared tunnel" | grep -v grep || echo "  (not running)"; \
	else \
		echo "âŒ No tunnel info found. Run: make -f Makefile.dev dev-start"; \
	fi

dev-status:
	@echo "ðŸ“Š Checking development status..."
	./scripts/dev-start.sh status

dev-logs:
	@echo "ðŸ“‹ Available log files:"
	@ls -la var/logs/dev_*.log 2>/dev/null || echo "No log files found"

dev-migrate:
	@echo "ðŸ—„ï¸  Running database migrations in development..."
	@if [ -f ".env.development" ]; then \
		source venv/bin/activate && export $$(grep -v '^#' .env.development | xargs) && \
		alembic upgrade head; \
	else \
		echo "âŒ .env.development not found. Please create it from .env.development.example"; \
		exit 1; \
	fi

dev-test:
	@echo "ðŸ§ª Running tests in development environment..."
	@if [ -f ".env.development" ]; then \
		source venv/bin/activate && export $$(grep -v '^#' .env.development | xargs) && \
		pytest tests/ -v; \
	else \
		echo "âŒ .env.development not found. Please create it from .env.development.example"; \
		exit 1; \
	fi

dev-clean:
	@echo "ðŸ§¹ Cleaning development artifacts..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -name "*.pyc" -delete 2>/dev/null || true
	rm -rf var/logs/dev_*.log var/logs/dev_*.pid
	rm -rf apps/frontend/dist apps/frontend/.vite

dev-cleanup:
	@echo "ðŸ§¹ Running orphaned process cleanup..."
	./scripts/cleanup_orphaned_processes.sh

dev-cleanup-cron-install:
	@echo "â° Installing cleanup cron job (runs every 5 minutes)..."
	@(crontab -l 2>/dev/null | grep -v "cleanup_orphaned_processes.sh"; \
		echo "*/5 * * * * /home/abcdeveloper/projects/analyticbot/scripts/cleanup_orphaned_processes.sh >> /tmp/analyticbot_cleanup.log 2>&1") | crontab -
	@echo "âœ… Cron job installed. View with: crontab -l"
	@echo "ðŸ“‹ Logs at: /tmp/analyticbot_cleanup.log"

dev-cleanup-cron-remove:
	@echo "ðŸ—‘ï¸  Removing cleanup cron job..."
	@(crontab -l 2>/dev/null | grep -v "cleanup_orphaned_processes.sh") | crontab -
	@echo "âœ… Cron job removed"

dev-kill-zombies:
	@echo "ðŸ’€ Force killing all zombie parent processes..."
	@ps aux | awk '$$8=="Z" {print $$3}' | while read ppid; do \
		if [ "$$ppid" != "1" ]; then \
			echo "Killing parent $$ppid"; \
			kill -TERM $$ppid 2>/dev/null || true; \
		fi; \
	done
	@echo "âœ… Zombie cleanup complete"

dev-prod-start:
	@echo "ðŸš€ Starting production API service (systemd)..."
	@sudo systemctl start analyticbot-api.service
	@sudo systemctl enable analyticbot-api.service
	@echo "âœ… Production API service started"

dev-prod-stop:
	@echo "ðŸ›‘ Stopping production API service (systemd)..."
	@sudo systemctl stop analyticbot-api.service
	@echo "âœ… Production API service stopped"

dev-prod-status:
	@systemctl status analyticbot-api.service | head -15

# ============================================================================
# Admin Panel Commands (Monorepo Structure: apps/frontend/apps/admin)
# ============================================================================

dev-admin-install:
	@echo "ðŸ“¦ Installing admin frontend dependencies..."
	cd apps/frontend/apps/admin && npm install

dev-admin-start:
	@echo "ðŸ” Starting admin frontend on port 11310..."
	@cd apps/frontend/apps/admin && npm run dev &
	@echo "âœ… Admin panel starting at http://localhost:11310"
	@echo "   Production URL: https://admin.analyticbot.org"

dev-admin-stop:
	@echo "ðŸ›‘ Stopping admin frontend..."
	@pkill -f "vite.*11310" 2>/dev/null || true
	@echo "âœ… Admin frontend stopped"

dev-admin-build:
	@echo "ðŸ—ï¸  Building admin frontend for production..."
	cd apps/frontend/apps/admin && npm run build
	@echo "âœ… Admin frontend built to apps/frontend/apps/admin/dist"
	@echo "   Deploy to: /var/www/analyticbot/admin"

# ============================================================================
# API Watchdog - Auto-restart API if it crashes
# ============================================================================

dev-watchdog-start:
	@echo "ðŸ• Starting API watchdog..."
	@pkill -f "api-watchdog.sh" 2>/dev/null || true
	@nohup ./scripts/api-watchdog.sh > /dev/null 2>&1 &
	@sleep 1
	@pgrep -f "api-watchdog.sh" > /dev/null && echo "âœ… API watchdog started" || echo "âŒ Failed to start watchdog"

dev-watchdog-stop:
	@echo "ðŸ›‘ Stopping API watchdog..."
	@pkill -f "api-watchdog.sh" 2>/dev/null || true
	@echo "âœ… API watchdog stopped"

dev-watchdog-status:
	@pgrep -f "api-watchdog.sh" > /dev/null && echo "ðŸ• API Watchdog: âœ… Running" || echo "ï¿½ï¿½ API Watchdog: âŒ Stopped"
	@tail -3 logs/watchdog.log 2>/dev/null || true

dev-watchdog-logs:
	@tail -50 logs/watchdog.log 2>/dev/null || echo "No watchdog logs found"
