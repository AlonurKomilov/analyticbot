# ğŸ“Š Complete Data Flow Architecture
## MTProto/Bot â†’ Backend â†’ Frontend â†’ User

**Last Updated:** November 6, 2025
**System Version:** 7.5.0

---

## ğŸ¯ Overview

This document explains **exactly** how data flows from Telegram channels through your system to the user's browser. Every step is documented with file paths and code references.

---

## ğŸ“¦ Complete Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        TELEGRAM ECOSYSTEM                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“± User's Telegram Channels                                                â”‚
â”‚     â”œâ”€ Messages (posts)                                                     â”‚
â”‚     â”œâ”€ Media (photos, videos)                                               â”‚
â”‚     â”œâ”€ Engagement (views, forwards, reactions)                              â”‚
â”‚     â””â”€ Metadata (date, author, etc)                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   MTProto Protocol      â”‚
                    â”‚  (Telegram's API)       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATA COLLECTION LAYER                                   â”‚
â”‚                   (apps/mtproto/collectors/)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1ï¸âƒ£  HISTORY COLLECTOR (Backfill)                                           â”‚
â”‚      File: apps/mtproto/collectors/history.py                               â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ class HistoryCollector:                                 â”‚            â”‚
â”‚      â”‚   â€¢ Collects historical messages (up to 100 per run)    â”‚            â”‚
â”‚      â”‚   â€¢ Rate limited (500ms between messages)               â”‚            â”‚
â”‚      â”‚   â€¢ Stores: posts, metrics snapshots                    â”‚            â”‚
â”‚      â”‚   â€¢ Method: backfill_history_for_peers()               â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚      Key Function:                                                           â”‚
â”‚      ```python                                                               â”‚
â”‚      async def backfill_history_for_peers(peers, limit=100):                â”‚
â”‚          # For each channel:                                                 â”‚
â”‚          for peer in peers:                                                  â”‚
â”‚              messages = tg_client.iter_history(peer, limit)                 â”‚
â”‚              for msg in messages:                                            â”‚
â”‚                  # Parse message                                             â”‚
â”‚                  normalized = parsers.normalize_message(msg)                â”‚
â”‚                  # Store in database                                         â”‚
â”‚                  await repos.post_repo.upsert_post(**normalized["post"])   â”‚
â”‚                  await repos.metrics_repo.add_snapshot(**normalized["metrics"])â”‚
â”‚      ```                                                                     â”‚
â”‚                                                                              â”‚
â”‚  2ï¸âƒ£  UPDATES COLLECTOR (Real-time)                                          â”‚
â”‚      File: apps/mtproto/collectors/updates.py                               â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ class UpdatesCollector:                                 â”‚            â”‚
â”‚      â”‚   â€¢ Listens for new messages in real-time              â”‚            â”‚
â”‚      â”‚   â€¢ Handles edits and deletions                         â”‚            â”‚
â”‚      â”‚   â€¢ Updates metrics automatically                       â”‚            â”‚
â”‚      â”‚   â€¢ Method: start_collecting()                         â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚      Key Function:                                                           â”‚
â”‚      ```python                                                               â”‚
â”‚      async def start_collecting():                                          â”‚
â”‚          async for event in tg_client.receive_updates():                   â”‚
â”‚              if event.new_message:                                          â”‚
â”‚                  normalized = parsers.normalize_message(event.message)     â”‚
â”‚                  await repos.post_repo.upsert_post(**normalized["post"])   â”‚
â”‚      ```                                                                     â”‚
â”‚                                                                              â”‚
â”‚  3ï¸âƒ£  DATA COLLECTION SERVICE (Orchestrator)                                 â”‚
â”‚      File: apps/mtproto/services/data_collection_service.py                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ class MTProtoDataCollectionService:                     â”‚            â”‚
â”‚      â”‚   â€¢ Multi-tenant: One user, multiple channels           â”‚            â”‚
â”‚      â”‚   â€¢ Coordinates history + updates collection            â”‚            â”‚
â”‚      â”‚   â€¢ Checks MTProto enabled per channel                  â”‚            â”‚
â”‚      â”‚   â€¢ Method: collect_user_channel_history()             â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚      Key Function:                                                           â”‚
â”‚      ```python                                                               â”‚
â”‚      async def collect_user_channel_history(user_id, limit=50):            â”‚
â”‚          # Get user's channels where MTProto is enabled                     â”‚
â”‚          channels = await get_user_mtproto_enabled_channels(user_id)       â”‚
â”‚          # Collect from each channel                                        â”‚
â”‚          for channel in channels:                                           â”‚
â”‚              await history_collector.collect_channel(channel, limit)       â”‚
â”‚      ```                                                                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Telethon Client      â”‚
                    â”‚  (Telegram Library)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATABASE LAYER                                       â”‚
â”‚                    (infra/db/repositories/)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ğŸ“Š POSTS TABLE (posts)                                                      â”‚
â”‚      File: infra/db/repositories/post_repository.py                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ Schema:                                                 â”‚            â”‚
â”‚      â”‚   â€¢ channel_id (FK to channels)                         â”‚            â”‚
â”‚      â”‚   â€¢ msg_id (Telegram message ID)                        â”‚            â”‚
â”‚      â”‚   â€¢ date (when posted)                                  â”‚            â”‚
â”‚      â”‚   â€¢ text (message content)                              â”‚            â”‚
â”‚      â”‚   â€¢ links_json (extracted URLs)                         â”‚            â”‚
â”‚      â”‚   â€¢ created_at, updated_at                              â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚      Key Methods:                                                            â”‚
â”‚      ```python                                                               â”‚
â”‚      async def upsert_post(channel_id, msg_id, date, text, links_json):    â”‚
â”‚          # Insert or update post                                            â”‚
â”‚          # Returns: {"inserted": bool, "updated": bool}                     â”‚
â”‚                                                                              â”‚
â”‚      async def get_channel_posts(channel_id, limit=100, offset=0):         â”‚
â”‚          # Get posts for a channel with pagination                          â”‚
â”‚          # Returns: list[dict] with post data                               â”‚
â”‚      ```                                                                     â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“ˆ POST METRICS TABLE (post_metrics)                                        â”‚
â”‚      File: infra/db/repositories/post_metrics_repository.py                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ Schema:                                                 â”‚            â”‚
â”‚      â”‚   â€¢ channel_id, msg_id (FK to posts)                    â”‚            â”‚
â”‚      â”‚   â€¢ views (view count)                                  â”‚            â”‚
â”‚      â”‚   â€¢ forwards (forward count)                            â”‚            â”‚
â”‚      â”‚   â€¢ replies_count (reply count)                         â”‚            â”‚
â”‚      â”‚   â€¢ reactions_count (reaction count)                    â”‚            â”‚
â”‚      â”‚   â€¢ snapshot_time (when collected)                      â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚      Key Methods:                                                            â”‚
â”‚      ```python                                                               â”‚
â”‚      async def add_or_update_snapshot(channel_id, msg_id, views, ...):     â”‚
â”‚          # Store metrics snapshot for a post                                â”‚
â”‚          # Creates time-series data for trending analysis                   â”‚
â”‚      ```                                                                     â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“º CHANNELS TABLE (channels)                                                â”‚
â”‚      File: infra/db/repositories/channel_repository.py                      â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ Schema:                                                 â”‚            â”‚
â”‚      â”‚   â€¢ id (channel ID)                                     â”‚            â”‚
â”‚      â”‚   â€¢ user_id (owner - FK to users)                       â”‚            â”‚
â”‚      â”‚   â€¢ title (channel name)                                â”‚            â”‚
â”‚      â”‚   â€¢ username (@channelname)                             â”‚            â”‚
â”‚      â”‚   â€¢ subscriber_count                                    â”‚            â”‚
â”‚      â”‚   â€¢ is_active                                           â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       BACKEND API LAYER                                      â”‚
â”‚                     (apps/api/routers/)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ğŸ”Œ POSTS ROUTER                                                             â”‚
â”‚      File: apps/api/routers/posts_router.py                                 â”‚
â”‚      Endpoints:                                                              â”‚
â”‚                                                                              â”‚
â”‚      1. GET /api/posts                                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚ â€¢ Returns: All posts for current user's channels    â”‚             â”‚
â”‚         â”‚ â€¢ Pagination: ?page=1&page_size=50                  â”‚             â”‚
â”‚         â”‚ â€¢ Filter: ?channel_id=123                           â”‚             â”‚
â”‚         â”‚ â€¢ Joins: posts + post_metrics (latest snapshot)     â”‚             â”‚
â”‚         â”‚ â€¢ Security: Only shows user's own channels          â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         SQL Query:                                                           â”‚
â”‚         ```sql                                                               â”‚
â”‚         SELECT                                                               â”‚
â”‚             p.channel_id, p.msg_id, p.date, p.text,                         â”‚
â”‚             c.title as channel_name,                                        â”‚
â”‚             pm.views, pm.forwards, pm.replies_count,                        â”‚
â”‚             pm.reactions_count, pm.snapshot_time                            â”‚
â”‚         FROM posts p                                                         â”‚
â”‚         LEFT JOIN channels c ON p.channel_id = c.id                         â”‚
â”‚         LEFT JOIN LATERAL (                                                  â”‚
â”‚             SELECT * FROM post_metrics                                       â”‚
â”‚             WHERE channel_id = p.channel_id AND msg_id = p.msg_id           â”‚
â”‚             ORDER BY snapshot_time DESC LIMIT 1                              â”‚
â”‚         ) pm ON true                                                         â”‚
â”‚         WHERE p.channel_id IN (                                              â”‚
â”‚             SELECT id FROM channels WHERE user_id = $1                       â”‚
â”‚         )                                                                    â”‚
â”‚         ORDER BY p.date DESC                                                 â”‚
â”‚         LIMIT $2 OFFSET $3                                                   â”‚
â”‚         ```                                                                  â”‚
â”‚                                                                              â”‚
â”‚      2. GET /api/posts/{channel_id}/{msg_id}                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚ â€¢ Returns: Single post with latest metrics          â”‚             â”‚
â”‚         â”‚ â€¢ Security: Verifies user owns channel              â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                              â”‚
â”‚      3. GET /api/channels/{channel_id}/posts                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚ â€¢ Returns: All posts for specific channel           â”‚             â”‚
â”‚         â”‚ â€¢ Same as /api/posts but pre-filtered               â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“Š ANALYTICS ROUTERS                                                        â”‚
â”‚      Files:                                                                  â”‚
â”‚      â€¢ apps/api/routers/analytics_post_dynamics_router.py                   â”‚
â”‚      â€¢ apps/api/routers/analytics_channels_router.py                        â”‚
â”‚      â€¢ apps/api/routers/statistics_core_router.py                           â”‚
â”‚                                                                              â”‚
â”‚      Endpoints:                                                              â”‚
â”‚                                                                              â”‚
â”‚      1. GET /analytics/posts/dynamics/post-dynamics/{channel_id}            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚ â€¢ Returns: Time-series post view dynamics           â”‚             â”‚
â”‚         â”‚ â€¢ Periods: 1h, 6h, 12h, 24h, 7d, 30d                â”‚             â”‚
â”‚         â”‚ â€¢ Uses post_metrics snapshots for trending          â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                              â”‚
â”‚      2. GET /analytics/posts/dynamics/top-posts/{channel_id}                â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚ â€¢ Returns: Top performing posts                     â”‚             â”‚
â”‚         â”‚ â€¢ Sort by: views, likes, shares, comments           â”‚             â”‚
â”‚         â”‚ â€¢ Periods: today, week, month                       â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                              â”‚
â”‚      3. GET /analytics/channels                                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚ â€¢ Returns: User's channels with post counts         â”‚             â”‚
â”‚         â”‚ â€¢ Cached: 10 minutes TTL                            â”‚             â”‚
â”‚         â”‚ â€¢ Joins: channels + scheduled_posts                 â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                              â”‚
â”‚      4. GET /statistics/channel-stats/{channel_id}                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚ â€¢ Returns: Comprehensive channel statistics         â”‚             â”‚
â”‚         â”‚ â€¢ Date range filtering                              â”‚             â”‚
â”‚         â”‚ â€¢ Aggregated metrics from post_metrics              â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                              â”‚
â”‚  ğŸ¤– BOT ANALYTICS (Alternative Data Source)                                  â”‚
â”‚      File: apps/bot/services/adapters/telegram_analytics_adapter.py         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ Note: Bot API has limitations:                          â”‚            â”‚
â”‚      â”‚   âŒ No view counts per message                          â”‚            â”‚
â”‚      â”‚   âŒ Limited engagement metrics                          â”‚            â”‚
â”‚      â”‚   âœ… Channel member counts                               â”‚            â”‚
â”‚      â”‚   âœ… Basic channel info                                  â”‚            â”‚
â”‚      â”‚                                                          â”‚            â”‚
â”‚      â”‚ MTProto is PREFERRED for detailed analytics             â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   HTTP/JSON API       â”‚
                    â”‚   (REST endpoints)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND LAYER                                        â”‚
â”‚                    (apps/frontend/src/)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ğŸ¨ PAGES & COMPONENTS                                                       â”‚
â”‚                                                                              â”‚
â”‚  1ï¸âƒ£  POSTS PAGE                                                              â”‚
â”‚      File: apps/frontend/src/pages/PostsPage.tsx                            â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ Features:                                               â”‚            â”‚
â”‚      â”‚   â€¢ Lists all collected posts                           â”‚            â”‚
â”‚      â”‚   â€¢ Filter by channel dropdown                          â”‚            â”‚
â”‚      â”‚   â€¢ Pagination (50 posts per page)                      â”‚            â”‚
â”‚      â”‚   â€¢ Shows: text, date, views, forwards, reactions       â”‚            â”‚
â”‚      â”‚   â€¢ Link to create scheduled posts                      â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚      Code Flow:                                                              â”‚
â”‚      ```typescript                                                           â”‚
â”‚      const PostsPage = () => {                                              â”‚
â”‚          const [posts, setPosts] = useState<Post[]>([]);                    â”‚
â”‚          const [selectedChannel, setSelectedChannel] = useState('all');     â”‚
â”‚                                                                              â”‚
â”‚          const fetchPosts = async () => {                                   â”‚
â”‚              const params = {                                               â”‚
â”‚                  page: 1,                                                   â”‚
â”‚                  page_size: 50,                                             â”‚
â”‚                  channel_id: selectedChannel !== 'all' ? selectedChannel : undefinedâ”‚
â”‚              };                                                             â”‚
â”‚              const response = await apiClient.get('/api/posts', { params });â”‚
â”‚              setPosts(response.posts);                                      â”‚
â”‚          };                                                                 â”‚
â”‚                                                                              â”‚
â”‚          // Renders table with columns:                                     â”‚
â”‚          // - Channel Name                                                  â”‚
â”‚          // - Message Text                                                  â”‚
â”‚          // - Date                                                          â”‚
â”‚          // - Views ğŸ‘ï¸                                                       â”‚
â”‚          // - Forwards â†—ï¸                                                    â”‚
â”‚          // - Reactions â¤ï¸                                                   â”‚
â”‚      };                                                                     â”‚
â”‚      ```                                                                     â”‚
â”‚                                                                              â”‚
â”‚  2ï¸âƒ£  DASHBOARD PAGE                                                          â”‚
â”‚      File: apps/frontend/src/pages/DashboardPage.tsx                        â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ Features:                                               â”‚            â”‚
â”‚      â”‚   â€¢ Overview metrics cards                              â”‚            â”‚
â”‚      â”‚   â€¢ Channel statistics                                  â”‚            â”‚
â”‚      â”‚   â€¢ Post performance charts                             â”‚            â”‚
â”‚      â”‚   â€¢ Uses: useAnalyticsStore                             â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â”‚  3ï¸âƒ£  ANALYTICS PAGE                                                          â”‚
â”‚      File: apps/frontend/src/pages/AnalyticsPage.tsx                        â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ Features:                                               â”‚            â”‚
â”‚      â”‚   â€¢ Advanced analytics dashboard                        â”‚            â”‚
â”‚      â”‚   â€¢ Post dynamics charts (time-series)                  â”‚            â”‚
â”‚      â”‚   â€¢ Top posts by views                                  â”‚            â”‚
â”‚      â”‚   â€¢ Engagement rate calculations                        â”‚            â”‚
â”‚      â”‚   â€¢ Growth trends                                       â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â”‚  4ï¸âƒ£  CHANNEL DETAILS PAGE                                                    â”‚
â”‚      File: apps/frontend/src/pages/ChannelDetailsPage.tsx                   â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ Features:                                               â”‚            â”‚
â”‚      â”‚   â€¢ Single channel deep dive                            â”‚            â”‚
â”‚      â”‚   â€¢ Channel-specific posts list                         â”‚            â”‚
â”‚      â”‚   â€¢ Performance metrics                                 â”‚            â”‚
â”‚      â”‚   â€¢ MTProto toggle control                              â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â”‚  5ï¸âƒ£  CHANNELS MANAGEMENT PAGE                                                â”‚
â”‚      File: apps/frontend/src/pages/ChannelsManagementPage.tsx               â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ Features:                                               â”‚            â”‚
â”‚      â”‚   â€¢ List all user channels                              â”‚            â”‚
â”‚      â”‚   â€¢ Add/remove channels                                 â”‚            â”‚
â”‚      â”‚   â€¢ Enable/disable MTProto per channel                  â”‚            â”‚
â”‚      â”‚   â€¢ View channel stats                                  â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â”‚  ğŸ“¦ STATE MANAGEMENT                                                         â”‚
â”‚      File: apps/frontend/src/store/slices/analytics/useAnalyticsStore.ts   â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ Zustand Store Methods:                                  â”‚            â”‚
â”‚      â”‚   â€¢ fetchPostDynamics(channelId, period)                â”‚            â”‚
â”‚      â”‚   â€¢ fetchTopPosts(channelId, limit)                     â”‚            â”‚
â”‚      â”‚   â€¢ fetchChannelAnalytics(channelId)                    â”‚            â”‚
â”‚      â”‚   â€¢ calculateEngagementRate(views, reactions, ...)      â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â”‚  ğŸ”§ API CLIENT                                                               â”‚
â”‚      File: apps/frontend/src/api/client.ts                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ Axios instance with:                                    â”‚            â”‚
â”‚      â”‚   â€¢ Base URL: http://localhost:11400                    â”‚            â”‚
â”‚      â”‚   â€¢ JWT authentication headers                          â”‚            â”‚
â”‚      â”‚   â€¢ Error handling & retry logic                        â”‚            â”‚
â”‚      â”‚   â€¢ Request/response interceptors                       â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          USER'S BROWSER                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‘¤ User sees:                                                               â”‚
â”‚     â€¢ All their Telegram channel posts in one dashboard                     â”‚
â”‚     â€¢ Real-time metrics (views, forwards, reactions)                        â”‚
â”‚     â€¢ Performance analytics and trends                                      â”‚
â”‚     â€¢ Top performing posts                                                  â”‚
â”‚     â€¢ Channel-by-channel breakdown                                          â”‚
â”‚     â€¢ Engagement rate calculations                                          â”‚
â”‚     â€¢ Growth over time charts                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Complete Request Flow Example

### User Opens Posts Page

**Step 1: User navigates to `/posts`**
```
Browser â†’ React Router â†’ PostsPage.tsx
```

**Step 2: Component loads and fetches channels**
```typescript
// PostsPage.tsx
useEffect(() => {
    if (channels.length === 0) {
        fetchChannels(); // Get user's channels for filter dropdown
    }
}, []);
```

**Step 3: API request to get channels**
```
Frontend â†’ GET /api/channels â†’ channels_router.py
         â†’ channel_repo.get_user_channels(user_id)
         â†’ SELECT * FROM channels WHERE user_id = $1
         â† Returns: [{ id: 123, title: "My Channel", ... }]
Frontend â† Channel list
```

**Step 4: Fetch posts with pagination**
```typescript
// PostsPage.tsx
const fetchPosts = async () => {
    const params = { page: 1, page_size: 50, channel_id: selectedChannel };
    const response = await apiClient.get('/api/posts', { params });
    setPosts(response.posts);
};
```

**Step 5: Backend processes request**
```
Frontend â†’ GET /api/posts?page=1&page_size=50&channel_id=123
         â†’ posts_router.py: get_all_posts()
         â†’ Validates user owns channel
         â†’ SQL query with LATERAL JOIN for latest metrics
         â†’ Fetches posts + joins post_metrics table
         â† Returns: { posts: [...], total: 250, page: 1, has_more: true }
Frontend â† Posts data displayed in table
```

**Step 6: User sees data in table**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Channel Name  â”‚ Message Text          â”‚ Date       â”‚ Views â”‚ ... â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ My Channel    â”‚ Hello world!          â”‚ Nov 6      â”‚ 1,234 â”‚ ... â•‘
â•‘ My Channel    â”‚ Check this out...     â”‚ Nov 5      â”‚ 856   â”‚ ... â•‘
â•‘ Tech Updates  â”‚ New features...       â”‚ Nov 5      â”‚ 2,103 â”‚ ... â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“Š Analytics Calculation Flow

### Example: Engagement Rate on Dashboard

**Step 1: User opens dashboard with channel selected**
```
Browser â†’ DashboardPage.tsx â†’ useAnalyticsStore.fetchChannelAnalytics(channelId)
```

**Step 2: Frontend calculates engagement**
```typescript
// apps/frontend/src/features/analytics/services/calculations.ts
export function calculateEngagementRate(metrics: {
    views: number;
    reactions: number;
    comments: number;
    shares: number;
}): number {
    const totalEngagements = reactions + comments + shares;
    return (totalEngagements / views) * 100;
}
```

**Step 3: Backend aggregates data**
```
Frontend â†’ GET /analytics/posts/dynamics/top-posts/123
         â†’ analytics_post_dynamics_router.py
         â†’ Queries post_metrics table
         â†’ Aggregates: SUM(views), SUM(forwards), SUM(reactions)
         â† Returns: { totalViews: 50000, totalReactions: 2500, ... }
Frontend â† Calculates: engagementRate = (2500 / 50000) * 100 = 5%
         â†’ Displays: "Engagement Rate: 5.0%" on card
```

---

## ğŸ” Security & Multi-Tenancy

### How User Isolation Works

Every query includes user authentication:

```sql
-- Posts query ALWAYS filters by user ownership
SELECT p.* FROM posts p
WHERE p.channel_id IN (
    SELECT id FROM channels WHERE user_id = $1  -- Current user's ID from JWT
)
```

**JWT Flow:**
1. User logs in â†’ receives JWT token
2. JWT stored in browser localStorage
3. Every API request includes: `Authorization: Bearer <jwt_token>`
4. Backend validates JWT â†’ extracts `user_id`
5. All database queries filtered by `user_id`

**Result:** Users can ONLY see their own channels and posts.

---

## ğŸ¯ MTProto vs Bot API

### Data Source Comparison

| Feature | MTProto (Telethon) | Bot API |
|---------|-------------------|---------|
| **View Counts** | âœ… Full access | âŒ Not available |
| **Message History** | âœ… Up to 100+ | âš ï¸ Limited |
| **Real-time Updates** | âœ… Full events | âš ï¸ Polling only |
| **Reactions** | âœ… Full data | âŒ Not available |
| **Forwards Count** | âœ… Full data | âŒ Not available |
| **Media Access** | âœ… Full access | âœ… Available |
| **Rate Limits** | âš ï¸ Strict | âœ… More lenient |

**Current System:**
- âœ… MTProto: Primary data source (detailed analytics)
- âœ… Bot API: Secondary (posting, basic info)
- âœ… User can toggle MTProto per channel
- âœ… Graceful fallback if MTProto disabled

---

## ğŸ“ Key File Reference

### Backend Collection
```
apps/mtproto/
â”œâ”€â”€ collectors/
â”‚   â”œâ”€â”€ history.py          # Backfill historical messages
â”‚   â””â”€â”€ updates.py          # Real-time message listener
â”œâ”€â”€ services/
â”‚   â””â”€â”€ data_collection_service.py  # Multi-tenant orchestrator
â””â”€â”€ config.py               # MTProto settings

infra/db/repositories/
â”œâ”€â”€ post_repository.py      # Posts CRUD
â”œâ”€â”€ post_metrics_repository.py  # Metrics time-series
â””â”€â”€ channel_repository.py   # Channel management
```

### Backend API
```
apps/api/routers/
â”œâ”€â”€ posts_router.py         # GET /api/posts
â”œâ”€â”€ analytics_post_dynamics_router.py  # POST dynamics & top posts
â”œâ”€â”€ analytics_channels_router.py       # Channel analytics
â””â”€â”€ statistics_core_router.py          # Aggregated stats
```

### Frontend Display
```
apps/frontend/src/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ PostsPage.tsx       # Main posts list
â”‚   â”œâ”€â”€ DashboardPage.tsx   # Overview dashboard
â”‚   â”œâ”€â”€ AnalyticsPage.tsx   # Advanced analytics
â”‚   â””â”€â”€ ChannelDetailsPage.tsx  # Single channel view
â”œâ”€â”€ store/slices/analytics/
â”‚   â””â”€â”€ useAnalyticsStore.ts    # State management
â””â”€â”€ features/analytics/services/
    â””â”€â”€ calculations.ts     # Business logic
```

---

## ğŸš€ Data Collection Schedule

### Automatic Collection (Background Jobs)

**Celery Tasks:**
```python
# Runs every 30 minutes
@celery.task
async def collect_all_users_data():
    # For each user with MTProto enabled:
    for user in active_users:
        await data_collection_service.collect_user_channel_history(
            user_id=user.id,
            limit_per_channel=50  # Last 50 messages
        )
```

**Manual Collection:**
- User can trigger: "Collect Now" button on channel page
- Endpoint: `POST /api/channels/{id}/collect`

---

## âœ… Verification Checklist

To verify data flow is working:

1. **MTProto Enabled?**
   ```bash
   # Check .env
   MTPROTO_ENABLED=true
   ```

2. **Data Collected?**
   ```sql
   SELECT COUNT(*) FROM posts;  -- Should have posts
   SELECT COUNT(*) FROM post_metrics;  -- Should have metrics
   ```

3. **API Working?**
   ```bash
   curl http://localhost:11400/api/posts?page=1 \
     -H "Authorization: Bearer <your_jwt>"
   ```

4. **Frontend Loading?**
   - Open `/posts` in browser
   - Check DevTools â†’ Network tab
   - Should see: `GET /api/posts` with 200 response

---

## ğŸ› Troubleshooting

### No Posts Showing

**Check 1: MTProto enabled globally**
```sql
SELECT mtproto_enabled FROM user_bot_credentials WHERE user_id = <your_id>;
```

**Check 2: Channel-specific override**
```sql
SELECT * FROM channel_mtproto_settings WHERE user_id = <your_id>;
```

**Check 3: Data collected**
```sql
SELECT channel_id, COUNT(*) FROM posts
WHERE channel_id IN (SELECT id FROM channels WHERE user_id = <your_id>)
GROUP BY channel_id;
```

### Metrics Not Showing

**Check: Metrics snapshots exist**
```sql
SELECT channel_id, msg_id, views, snapshot_time
FROM post_metrics
WHERE channel_id = <your_channel_id>
ORDER BY snapshot_time DESC
LIMIT 10;
```

---

## ğŸ‰ Summary

**Data flows from:**
1. ğŸ“± Telegram channels (your content)
2. â¬‡ï¸ MTProto collectors (HistoryCollector, UpdatesCollector)
3. ğŸ’¾ PostgreSQL database (posts, post_metrics tables)
4. ğŸ”Œ FastAPI routers (REST endpoints)
5. ğŸŒ React frontend (pages & components)
6. ğŸ‘¤ User's browser (dashboard, tables, charts)

**Result:** User sees all their Telegram channel analytics in one unified dashboard with real-time metrics and historical trends.

---

**Questions?** Check these docs:
- [MTProto Setup Guide](./MTPROTO_SETUP.md)
- [API Documentation](./API.md)
- [Frontend Architecture](./FRONTEND_ARCHITECTURE.md)
