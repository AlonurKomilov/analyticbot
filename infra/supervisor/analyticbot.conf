; Supervisor configuration for AnalyticBot services
; Install: sudo apt install supervisor
; Copy to: /etc/supervisor/conf.d/analyticbot.conf
; Commands:
;   sudo supervisorctl reread
;   sudo supervisorctl update
;   sudo supervisorctl status analyticbot:*
;   sudo supervisorctl restart analyticbot:*

[group:analyticbot]
programs=analyticbot-api,analyticbot-bot,analyticbot-mtproto-worker

; ============================================================================
; API Server
; ============================================================================
[program:analyticbot-api]
command=/opt/analyticbot/.venv/bin/uvicorn apps.api.main:app
    --host 0.0.0.0
    --port 8000
    --workers 4
    --log-level info
directory=/opt/analyticbot
user=analyticbot
autostart=true
autorestart=true
startretries=5
stopwaitsecs=30
stopasgroup=true
killasgroup=true
stdout_logfile=/opt/analyticbot/logs/supervisor_api.log
stderr_logfile=/opt/analyticbot/logs/supervisor_api_error.log
environment=PATH="/opt/analyticbot/.venv/bin:/usr/local/bin:/usr/bin:/bin"

; ============================================================================
; Telegram Bot
; ============================================================================
[program:analyticbot-bot]
command=/opt/analyticbot/.venv/bin/python -m apps.bot.run_bot
directory=/opt/analyticbot
user=analyticbot
autostart=true
autorestart=true
startretries=5
stopwaitsecs=30
stopasgroup=true
killasgroup=true
stdout_logfile=/opt/analyticbot/logs/supervisor_bot.log
stderr_logfile=/opt/analyticbot/logs/supervisor_bot_error.log
environment=PATH="/opt/analyticbot/.venv/bin:/usr/local/bin:/usr/bin:/bin"

; ============================================================================
; MTProto Data Collection Worker
; ============================================================================
[program:analyticbot-mtproto-worker]
command=/opt/analyticbot/.venv/bin/python -m apps.mtproto.worker
    --interval 10
    --max-runtime 24
    --memory-limit 2048
    --cpu-limit 80
    --health-port 9091
    --log-level INFO
directory=/opt/analyticbot
user=analyticbot
autostart=true
autorestart=true
startretries=5
stopwaitsecs=30
stopasgroup=true
killasgroup=true
stdout_logfile=/opt/analyticbot/logs/supervisor_mtproto.log
stderr_logfile=/opt/analyticbot/logs/supervisor_mtproto_error.log
environment=PATH="/opt/analyticbot/.venv/bin:/usr/local/bin:/usr/bin:/bin"

; ============================================================================
; Event Listeners (Optional - for notifications)
; ============================================================================
[eventlistener:analyticbot-crash-mail]
command=/opt/analyticbot/.venv/bin/crashmail
    --to=admin@example.com
    --from=supervisor@analyticbot.com
    --subject="AnalyticBot Process Crashed"
events=PROCESS_STATE_FATAL
buffer_size=1000
